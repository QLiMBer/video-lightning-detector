#!/usr/bin/env bash
set -euo pipefail

# Optional: activate local toolchain if present
if [ -f ./env.sh ]; then
  # shellcheck disable=SC1091
  source ./env.sh
fi

echo "[pre-push] Checking Go formatting…"
changed=$(git ls-files '*.go' | xargs -r gofmt -l || true)
if [ -n "$changed" ]; then
  echo "Unformatted Go files detected:" >&2
  echo "$changed" >&2
  echo "Run: go fmt ./..." >&2
  exit 1
fi

echo "[pre-push] go vet…"
go vet ./...

echo "[pre-push] go build (packages)…"
go build ./...

echo "[pre-push] go test…"
go test ./...

echo "[pre-push] OK"

